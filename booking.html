<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book a Class - Gym10</title>
    <link rel="stylesheet" href="styles.css" />
    <script defer src="script.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
      .logo-img {
        max-width: 90px; /* You can adjust the size */
        height: auto;
      }
      .action-buttons {
        display: flex;
        justify-content: center; /* Center buttons horizontally */
        gap: 20px; /* Space between buttons */
        margin-top: 20px; /* Space above the buttons */
      }

      .action-buttons button {
        padding: 12px 20px; /* Button padding */
        font-size: 1em; /* Font size */
        color: white; /* Text color */
        background-color: #007bff; /* Button background color */
        border: none; /* Remove border */
        border-radius: 5px; /* Rounded corners */
        cursor: pointer; /* Pointer cursor on hover */
        transition: background-color 0.3s ease, transform 0.3s ease; /* Transition effects */
      }

      .action-buttons button:hover {
        background-color: #0056b3; /* Darker background on hover */
        transform: translateY(-2px); /* Lift effect on hover */
      }

      .action-buttons button:focus {
        outline: none; /* Remove outline on focus */
      }
      #booking-info {
        min-height: 200px; /* Adjust the minimum height as needed */
        padding: 15px; /* Add some padding for better spacing */
        border: 1px solid #ccc; /* Optional: Add a border for better visibility */
        border-radius: 8px; /* Optional: Add rounded corners */
        background-color: rgba(
          240,
          240,
          240,
          0.8
        ); /* Light background for contrast */
        display: flex; /* Make it a flex container */
        align-items: center; /* Center content vertically */
        justify-content: center; /* Center content horizontally */
        text-align: center; /* Center text alignment */
      }
      .action-buttons {
        min-height: 100px; /* Adjust the minimum height as needed */
        display: flex; /* Use flexbox for alignment */
        justify-content: center; /* Center the buttons horizontally */
        align-items: center; /* Center the buttons vertically */
        gap: 20px; /* Space between the buttons */
        margin-top: 30px; /* Optional: space above the action buttons */
        padding: 20px; /* Optional: add some padding for spacing */
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <img src="img/logo.jpg" alt="Gym10 Logo" class="logo-img" />
        <ul class="nav-links">
          <li><a href="client_dashboard.html">Back To Dashboard</a></li>
          <li>
            <a href="account.html" class="booking-btn active">Manage Account</a>
          </li>
        </ul>
      </nav>
      <h1>Book a Class</h1>
    </header>
    <main>
      <h2>Select a Class</h2>
      <div class="container">
        <p>Please fill in the details below to book your class.</p>

        <div id="message-container" style="display: none"></div>

        <form id="booking-form">
          <div class="form-group">
            <label for="class">Class:</label>
            <select id="class" name="class" required>
              <option value="">Select a class</option>
              <!-- Classes will be loaded dynamically -->
            </select>
          </div>

          <div class="form-group">
            <label for="trainer">Trainer:</label>
            <select id="trainer" name="trainer" required>
              <option value="">Select a trainer</option>
              <!-- Trainers will be loaded dynamically -->
            </select>
          </div>

          <div class="form-group">
            <label for="date">Date:</label>
            <input type="date" id="date" name="date" required />
          </div>

          <div class="form-group">
            <label for="start_time">Start Time:</label>
            <input type="time" id="start_time" name="start_time" required />
          </div>

          <div class="form-group">
            <label for="end_time">End Time:</label>
            <input type="time" id="end_time" name="end_time" required />
          </div>

          <button type="submit" class="btn">Book Now</button>
        </form>
      </div>

      <h3>Your Bookings:</h3>
      <div id="booking-info" class="booking-list">
        <p>Your bookings will be loaded here!</p>
      </div>

      <!-- Buttons for managing bookings -->
      <div class="action-buttons">
        <button onclick="window.location.href='booking.html'">
          Book a New Class
        </button>
        <button onclick="window.location.href='manage_bookings.html'">
          Manage Bookings
        </button>
      </div>
    </main>
    <footer>
      <p>&copy; 2024 Gym10 - All Rights Reserved</p>
    </footer>

    <script>
      $(document).ready(function () {
        // Load classes
        $.ajax({
          url: "get_classes.php",
          type: "GET",
          dataType: "json",
          success: function (response) {
            if (response.success) {
              const classSelect = $("#class");
              if (response.data && response.data.length > 0) {
                response.data.forEach(function (classItem) {
                  // Format the class information for display
                  const classInfo = `${classItem.name} (${classItem.class_type}) - ${classItem.schedule_date} ${classItem.start_time}-${classItem.end_time}`;
                  classSelect.append(
                    `<option value="${classItem.id}" 
                      data-start-time="${classItem.start_time}"
                      data-end-time="${classItem.end_time}"
                      data-schedule-date="${classItem.schedule_date}"
                      data-class-type="${classItem.class_type}"
                      data-trainer-id="${classItem.trainer_id}">
                      ${classInfo}
                    </option>`
                  );
                });
              } else {
                classSelect.append(
                  '<option value="" disabled>No classes available</option>'
                );
              }

              // When a class is selected, update the date and time fields
              $("#class").change(function () {
                const selectedOption = $(this).find("option:selected");
                if (selectedOption.val()) {
                  $("#date").val(selectedOption.data("schedule-date"));
                  $("#start_time").val(selectedOption.data("start-time"));
                  $("#end_time").val(selectedOption.data("end-time"));
                  // Update trainer dropdown to show only available trainers for this class
                  updateTrainerDropdown(selectedOption.data("trainer-id"));
                }
              });
            } else {
              $("#class").append(
                '<option value="" disabled>Error loading classes</option>'
              );
            }
          },
          error: function () {
            $("#class").append(
              '<option value="" disabled>Error loading classes</option>'
            );
          },
        });

        // Load trainers
        $.ajax({
          url: "get_trainers.php",
          type: "GET",
          dataType: "json",
          success: function (response) {
            if (response.success) {
              const trainerSelect = $("#trainer");
              if (response.data && response.data.length > 0) {
                response.data.forEach(function (trainer) {
                  // Format the trainer information for display
                  const trainerInfo = `${trainer.name} (${trainer.expertise}) - Available Slots: ${trainer.available_slots}`;
                  trainerSelect.append(
                    `<option value="${trainer.id}" 
                      data-expertise="${trainer.expertise}"
                      data-available-slots="${trainer.available_slots}">
                      ${trainerInfo}
                    </option>`
                  );
                });
              } else {
                trainerSelect.append(
                  '<option value="" disabled>No trainers available</option>'
                );
              }
            } else {
              $("#trainer").append(
                '<option value="" disabled>Error loading trainers</option>'
              );
            }
          },
          error: function () {
            $("#trainer").append(
              '<option value="" disabled>Error loading trainers</option>'
            );
          },
        });

        // Function to update trainer dropdown based on selected class
        function updateTrainerDropdown(trainerId) {
          const trainerSelect = $("#trainer");
          trainerSelect.val(trainerId); // Select the trainer assigned to this class
          trainerSelect.prop("disabled", true); // Disable trainer selection as it's pre-assigned
        }

        // Reset trainer dropdown when form is reset
        $("#booking-form").on("reset", function () {
          $("#trainer").prop("disabled", false);
        });

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];
        $("#date").attr("min", today);

        // Form submission
        $("#booking-form").submit(function (e) {
          e.preventDefault();

          // Validate form inputs
          const classId = $("#class").val();
          const trainerId = $("#trainer").val();
          const date = $("#date").val();
          const startTime = $("#start_time").val();
          const endTime = $("#end_time").val();

          if (!classId || !trainerId || !date || !startTime || !endTime) {
            showMessage("error", "Please fill in all required fields");
            return;
          }

          // Validate date is not in the past
          const selectedDate = new Date(date);
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          if (selectedDate < today) {
            showMessage("error", "Please select a future date");
            return;
          }

          // Validate time slots
          if (startTime >= endTime) {
            showMessage("error", "End time must be after start time");
            return;
          }

          // Create booking data object
          const bookingData = {
            class_id: parseInt(classId),
            trainer_id: parseInt(trainerId),
            booking_date: date,
            start_time: startTime,
            end_time: endTime,
          };

          // Send AJAX request
          $.ajax({
            url: "create_booking.php",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(bookingData),
            dataType: "json",
            success: function (response) {
              if (response.success) {
                showMessage(
                  "success",
                  "Booking created successfully! Redirecting to dashboard..."
                );
                setTimeout(function () {
                  window.location.href = "client_dashboard.html";
                }, 2000);
              } else {
                showMessage(
                  "error",
                  response.message || "Failed to create booking"
                );
                if (response.errors) {
                  console.error("Validation errors:", response.errors);
                }
              }
            },
            error: function (xhr, status, error) {
              showMessage(
                "error",
                "An error occurred. Please try again later."
              );
              console.error("Error:", error);
              console.error("Response:", xhr.responseText);
            },
          });
        });

        // Function to show messages
        function showMessage(type, message) {
          const messageContainer = $("#message-container");
          messageContainer.removeClass("success error").addClass(type);
          messageContainer.html(`<p>${message}</p>`).show();

          // Hide message after 5 seconds
          setTimeout(() => {
            messageContainer.fadeOut();
          }, 5000);
        }

        // Load existing bookings
        function loadBookings() {
          $.ajax({
            url: "fetch_booking.php",
            type: "GET",
            dataType: "json",
            success: function (response) {
              const bookingInfo = $("#booking-info");
              if (response.length > 0) {
                let html = "<h3>Your Current Bookings:</h3><ul>";
                response.forEach((booking) => {
                  html += `<li>${booking.ClassName} with ${booking.TrainerName} on ${booking.BookingDate} (${booking.StartTime} - ${booking.EndTime})</li>`;
                });
                html += "</ul>";
                bookingInfo.html(html);
              } else {
                bookingInfo.html("<p>You have no current bookings.</p>");
              }
            },
            error: function (xhr, status, error) {
              console.error("Error loading bookings:", error);
              $("#booking-info").html(
                "<p>Error loading bookings. Please try again later.</p>"
              );
            },
          });
        }

        // Load bookings when page loads
        loadBookings();
      });
    </script>
  </body>
</html>
