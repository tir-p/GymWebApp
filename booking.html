<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Book a Class - Gym10</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Navbar -->
    <nav class="bg-black">
      <div
        class="container mx-auto flex items-center justify-between py-4 px-6"
      >
        <div class="flex items-center gap-3">
          <img
            src="img/logo.jpg"
            alt="Gym10 Logo"
            class="h-10 w-10 rounded-full"
          />
          <span class="text-xl font-bold text-green-400">Gym10</span>
        </div>
        <ul class="flex gap-6">
          <li>
            <a
              href="client_dashboard.html"
              class="text-white hover:text-green-400 transition"
              >Dashboard</a
            >
          </li>
          <li>
            <a
              href="account.html"
              class="text-white hover:text-green-400 transition"
              >Account</a
            >
          </li>
          <li>
            <a
              href="logout.php"
              class="ml-4 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition"
              >Logout</a
            >
          </li>
        </ul>
      </div>
    </nav>

    <main class="container mx-auto py-10">
      <h1 class="text-3xl font-bold mb-8 text-center text-green-600">
        Book a Class
      </h1>
      <div id="message-container" class="hidden mb-4"></div>
      <form
        id="booking-form"
        class="bg-white rounded-lg shadow p-8 max-w-lg mx-auto space-y-6"
      >
        <div>
          <label for="class" class="block font-semibold mb-1">Class</label>
          <select
            id="class"
            name="class"
            required
            class="w-full border border-gray-300 rounded px-3 py-2"
          ></select>
        </div>
        <div>
          <label for="trainer" class="block font-semibold mb-1">Trainer</label>
          <select
            id="trainer"
            name="trainer"
            required
            class="w-full border border-gray-300 rounded px-3 py-2"
          ></select>
        </div>
        <div>
          <label for="date" class="block font-semibold mb-1">Date</label>
          <input
            type="date"
            id="date"
            name="date"
            required
            class="w-full border border-gray-300 rounded px-3 py-2"
          />
        </div>
        <div>
          <label for="start_time" class="block font-semibold mb-1"
            >Start Time</label
          >
          <input
            type="time"
            id="start_time"
            name="start_time"
            required
            class="w-full border border-gray-300 rounded px-3 py-2"
          />
        </div>
        <div>
          <label for="end_time" class="block font-semibold mb-1"
            >End Time</label
          >
          <input
            type="time"
            id="end_time"
            name="end_time"
            required
            class="w-full border border-gray-300 rounded px-3 py-2"
          />
        </div>
        <button
          type="submit"
          class="w-full bg-green-500 text-white font-semibold py-2 rounded hover:bg-green-600 transition"
        >
          Book Now
        </button>
      </form>
      <div
        id="booking-info"
        class="mt-10 bg-white rounded-lg shadow p-6 max-w-lg mx-auto"
      >
        <h3 class="text-lg font-bold mb-4 text-green-600">Your Bookings</h3>
        <div id="booking-list">
          <p>Loading bookings...</p>
        </div>
      </div>
    </main>

    <footer class="bg-black text-white py-6 mt-10">
      <div class="container mx-auto text-center">
        &copy; 2024 Gym10 - All Rights Reserved
      </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      // Show message
      function showMessage(type, message) {
        const msg = $("#message-container");
        msg
          .removeClass()
          .addClass(
            type === "success"
              ? "bg-green-100 text-green-700 p-4 rounded mb-4"
              : "bg-red-100 text-red-700 p-4 rounded mb-4"
          );
        msg.html(message).show();
        setTimeout(() => msg.fadeOut(), 4000);
      }

      // Load classes
      function loadClasses() {
        $.get(
          "get_classes.php",
          function (response) {
            const classSelect = $("#class");
            classSelect.html('<option value="">Select a class</option>');
            if (response.success && response.data.length > 0) {
              response.data.forEach(function (classItem) {
                classSelect.append(
                  `<option value="${classItem.id}" data-trainer-id="${classItem.trainer_id}" data-schedule-date="${classItem.schedule_date}" data-start-time="${classItem.start_time}" data-end-time="${classItem.end_time}">${classItem.name} (${classItem.class_type}) - ${classItem.schedule_date} ${classItem.start_time}-${classItem.end_time}</option>`
                );
              });
            } else {
              classSelect.append(
                '<option value="" disabled>No classes available</option>'
              );
            }
          },
          "json"
        );
      }

      // Load trainers
      function loadTrainers() {
        $.get(
          "get_trainers.php",
          function (response) {
            const trainerSelect = $("#trainer");
            trainerSelect.html('<option value="">Select a trainer</option>');
            if (response.success && response.data.length > 0) {
              response.data.forEach(function (trainer) {
                trainerSelect.append(
                  `<option value="${trainer.id}">${trainer.name} (${trainer.expertise})</option>`
                );
              });
            } else {
              trainerSelect.append(
                '<option value="" disabled>No trainers available</option>'
              );
            }
          },
          "json"
        );
      }

      // Load bookings
      function loadBookings() {
        $.get(
          "fetch_booking.php",
          function (bookings) {
            if (bookings.length > 0) {
              let html = '<ul class="space-y-2">';
              bookings.forEach(function (booking) {
                html += `<li class="flex justify-between items-center">
              <span>${booking.ClassName} with ${booking.TrainerName} on ${booking.BookingDate} (${booking.StartTime} - ${booking.EndTime})</span>
              <button class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 transition" onclick="cancelBooking(${booking.BookingID})">Cancel</button>
            </li>`;
              });
              html += "</ul>";
              $("#booking-list").html(html);
            } else {
              $("#booking-list").html("<p>You have no current bookings.</p>");
            }
          },
          "json"
        );
      }

      // Cancel booking
      function cancelBooking(bookingId) {
        if (!confirm("Are you sure you want to cancel this booking?")) return;
        $.ajax({
          url: "web_services/booking_service.php?booking_id=" + bookingId,
          type: "DELETE",
          dataType: "json",
          success: function (response) {
            if (response.status === "success") {
              showMessage("success", "Booking cancelled successfully");
              loadBookings();
            } else {
              showMessage(
                "error",
                response.message || "Failed to cancel booking"
              );
            }
          },
          error: function () {
            showMessage(
              "error",
              "An error occurred while cancelling the booking"
            );
          },
        });
      }

      // On page load
      $(function () {
        loadClasses();
        loadTrainers();
        loadBookings();

        // When a class is selected, update the date and time fields
        $("#class").change(function () {
          const selected = $(this).find("option:selected");
          if (selected.val()) {
            $("#date").val(selected.data("schedule-date"));
            $("#start_time").val(selected.data("start-time"));
            $("#end_time").val(selected.data("end-time"));
            $("#trainer").val(selected.data("trainer-id"));
          }
        });

        // Booking form submit
        $("#booking-form").submit(function (e) {
          e.preventDefault();
          const classId = $("#class").val();
          const trainerId = $("#trainer").val();
          const date = $("#date").val();
          const startTime = $("#start_time").val();
          const endTime = $("#end_time").val();

          if (!classId || !trainerId || !date || !startTime || !endTime) {
            showMessage("error", "Please fill in all required fields");
            return;
          }
          if (startTime >= endTime) {
            showMessage("error", "End time must be after start time");
            return;
          }

          const bookingData = {
            class_id: parseInt(classId),
            trainer_id: parseInt(trainerId),
            booking_date: date,
            start_time: startTime,
            end_time: endTime,
          };

          $.ajax({
            url: "create_booking.php",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(bookingData),
            dataType: "json",
            success: function (response) {
              if (response.success) {
                showMessage("success", "Booking created successfully!");
                $("#booking-form")[0].reset();
                loadBookings();
              } else {
                showMessage(
                  "error",
                  response.message || "Failed to create booking"
                );
              }
            },
            error: function () {
              showMessage(
                "error",
                "An error occurred. Please try again later."
              );
            },
          });
        });
      });
    </script>
  </body>
</html>
